{{ 'custom-sections.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign section_width = section.settings.section_width | default: 'full-width'
  assign columns = section.settings.columns | default: 3
  assign columns_mobile = section.settings.columns_mobile | default: 2
  assign heading_size = section.settings.heading_size | default: 20
  assign heading_alignment = section.settings.heading_alignment | default: 'left'
  assign products_to_show = section.settings.products_to_show | default: 6
-%}

{%- comment -%} Scoped styles for dynamic customizer values {%- endcomment -%}
<style>
  #ProductGrid-{{ section.id }} {
    --cpg-columns: {{ columns }};
    --cpg-columns-mobile: {{ columns_mobile }};
    --cpg-heading-size: {{ heading_size }}px;
    --cpg-heading-align: {{ heading_alignment }};
  }

  /* Hide cards beyond the products_to_show limit */
  #ProductGrid-{{ section.id }} .custom-product-grid__grid > .custom-product-grid__card:nth-child(n + {{ products_to_show | plus: 1 }}) {
    display: none;
  }
</style>

<section
  id="ProductGrid-{{ section.id }}"
  class="custom-product-grid section section--{{ section_width }} color-{{ section.settings.color_scheme }} spacing-style"
  style="{% render 'spacing-padding', settings: section.settings %}"
  data-section-id="{{ section.id }}"
  data-section-type="custom-product-grid"
>

  {%- comment -%} Section heading {%- endcomment -%}
  {%- if section.settings.heading != blank -%}
    <h2 class="custom-product-grid__heading">{{ section.settings.heading }}</h2>
  {%- endif -%}

  {%- comment -%}
    Product cards grid — rendered via content_for 'blocks' for proper
    theme-level block rendering. Each block embeds its own product JSON
    data for the popup JS. Display limit handled via CSS :nth-child above.
  {%- endcomment -%}
  <div class="custom-product-grid__grid">
    {%- content_for 'blocks' -%}
  </div>

  {%- comment -%}
    ========================================================================
    Popup Overlay — Single shared popup, populated dynamically via JS
    ========================================================================
  {%- endcomment -%}
  <div
    id="CustomPopupOverlay-{{ section.id }}"
    class="custom-popup-overlay"
    role="dialog"
    aria-modal="true"
    aria-label="Product details"
  >
    <div class="custom-popup">
      {%- comment -%} Close button {%- endcomment -%}
      <button class="custom-popup__close" type="button" aria-label="Close popup">&times;</button>

      {%- comment -%} Top row: product image (left) + basic info (right) {%- endcomment -%}
      <div class="custom-popup__top">
        <div class="custom-popup__image-wrapper">
          <img class="custom-popup__image" src="" alt="" loading="lazy">
        </div>
        <div class="custom-popup__info">
          <h2 class="custom-popup__name"></h2>
          <p class="custom-popup__price"></p>
          <p class="custom-popup__description"></p>
        </div>
      </div>

      {%- comment -%} Bottom: variants + ATC — full width below the image row {%- endcomment -%}
      <div class="custom-popup__bottom">
        <div class="custom-popup__variants"></div>

        {%- comment -%} Success message after add to cart {%- endcomment -%}
        <div class="custom-popup__success-message">Added to cart successfully!</div>

        {%- comment -%} Add to Cart button with arrow icon {%- endcomment -%}
        <button
          class="custom-popup__add-to-cart"
          type="button"
          disabled
        >
          <span class="custom-popup__atc-text">ADD TO CART</span>
          <span class="custom-popup__atc-arrow"></span>
        </button>
      </div>
    </div>
  </div>

  {%- comment -%}
    ========================================================================
    Store all product handles for the "Soft Winter Jacket" auto-add rule.
    We find the Soft Winter Jacket variant ID at runtime.
    ========================================================================
  {%- endcomment -%}
  {%- assign soft_winter_jacket = all_products['soft-winter-jacket'] -%}
  {%- if soft_winter_jacket != blank -%}
    <script type="application/json" id="SoftWinterJacketData-{{ section.id }}">
      {
        "id": {{ soft_winter_jacket.id }},
        "handle": "soft-winter-jacket",
        "firstAvailableVariantId": {{ soft_winter_jacket.selected_or_first_available_variant.id }}
      }
    </script>
  {%- endif -%}

</section>

{%- comment -%}
  ============================================================================
  Vanilla JavaScript — Product Grid Popup & Add to Cart
  ============================================================================
  - No jQuery dependency
  - Opens popup with product data on hotspot click
  - Renders variant options dynamically
  - Matches selected options to the correct variant ID
  - Adds to cart via Shopify /cart/add.js API
  - Auto-adds "Soft Winter Jacket" when variant with Black + Medium is carted
  ============================================================================
{%- endcomment -%}
<script>
  (function() {
    'use strict';

    /* ------------------------------------------------------------------
       CONFIGURATION & DOM REFERENCES
       ------------------------------------------------------------------ */
    var sectionId = '{{ section.id }}';
    var overlay = document.getElementById('CustomPopupOverlay-' + sectionId);
    var popup = overlay.querySelector('.custom-popup');
    var closeBtn = overlay.querySelector('.custom-popup__close');
    var popupImage = overlay.querySelector('.custom-popup__image');
    var popupName = overlay.querySelector('.custom-popup__name');
    var popupPrice = overlay.querySelector('.custom-popup__price');
    var popupDesc = overlay.querySelector('.custom-popup__description');
    var popupVariants = overlay.querySelector('.custom-popup__variants');
    var addToCartBtn = overlay.querySelector('.custom-popup__add-to-cart');
    var successMsg = overlay.querySelector('.custom-popup__success-message');

    /* ------------------------------------------------------------------
       LOAD PRODUCT DATA FROM EMBEDDED BLOCK SCRIPTS
       Each block outputs its own <script class="cpg-product-data"> tag
       with the product JSON inside the card element.
       ------------------------------------------------------------------ */
    var productData = {};
    var dataScripts = document.querySelectorAll('#ProductGrid-' + sectionId + ' .cpg-product-data');
    dataScripts.forEach(function(script) {
      try {
        var data = JSON.parse(script.textContent);
        if (data && data.handle) {
          productData[data.handle] = data;
        }
      } catch (e) {
        console.error('Custom Product Grid: Failed to parse product data', e);
      }
    });

    /* Load Soft Winter Jacket data if available */
    var softWinterJacketData = null;
    var jacketDataEl = document.getElementById('SoftWinterJacketData-' + sectionId);
    if (jacketDataEl) {
      try {
        softWinterJacketData = JSON.parse(jacketDataEl.textContent);
      } catch (e) {
        console.error('Custom Product Grid: Failed to parse jacket data', e);
      }
    }

    /* ------------------------------------------------------------------
       STATE: tracks currently selected options for the open popup
       ------------------------------------------------------------------ */
    var currentProduct = null;    /* The product object currently in the popup */
    var selectedOptions = {};     /* { optionName: selectedValue } */

    /* ------------------------------------------------------------------
       OPEN POPUP
       Populates all popup fields from the product data store.
       ------------------------------------------------------------------ */
    function openPopup(handle) {
      var product = productData[handle];
      if (!product) return;

      currentProduct = product;
      selectedOptions = {};

      /* Populate basic product info */
      popupImage.src = product.image;
      popupImage.alt = product.imageAlt;
      popupName.textContent = product.title;
      popupPrice.textContent = product.price;
      popupDesc.textContent = product.description;

      /* Build variant option groups dynamically */
      renderVariants(product);

      /* Reset button and messages */
      addToCartBtn.disabled = true;
      addToCartBtn.classList.remove('custom-popup__add-to-cart--loading');
      addToCartBtn.innerHTML = '<span class="custom-popup__atc-text">ADD TO CART</span><span class="custom-popup__atc-arrow"></span>';
      successMsg.classList.remove('custom-popup__success-message--visible');

      /* Show overlay with animation */
      overlay.classList.add('custom-popup-overlay--active');
      document.body.style.overflow = 'hidden';

      /* Focus trap: focus the close button for accessibility */
      closeBtn.focus();
    }

    /* ------------------------------------------------------------------
       CLOSE POPUP
       ------------------------------------------------------------------ */
    function closePopup() {
      overlay.classList.remove('custom-popup-overlay--active');
      document.body.style.overflow = '';
      currentProduct = null;
      selectedOptions = {};
    }

    /* ------------------------------------------------------------------
       COLOR MAP — Maps common color names to hex values for swatches.
       Falls back to a neutral gray for unknown colors.
       ------------------------------------------------------------------ */
    var colorMap = {
      'red': '#c0392b', 'grey': '#95a5a6', 'gray': '#95a5a6',
      'black': '#1a1a1a', 'white': '#ffffff', 'blue': '#2980b9',
      'navy': '#2c3e50', 'green': '#27ae60', 'pink': '#e91e8a',
      'beige': '#d4c5a9', 'brown': '#8B4513', 'orange': '#e67e22',
      'yellow': '#f1c40f', 'purple': '#8e44ad', 'cream': '#FFFDD0',
      'ivory': '#FFFFF0', 'khaki': '#c3b091', 'olive': '#808000',
      'burgundy': '#800020', 'coral': '#FF7F50', 'teal': '#008080',
      'maroon': '#800000', 'tan': '#D2B48C', 'gold': '#CFB53B',
      'silver': '#C0C0C0', 'charcoal': '#36454F', 'nude': '#E3BC9A',
      'camel': '#C19A6B', 'lavender': '#E6E6FA', 'mint': '#98FF98',
      'rose': '#FF007F', 'rust': '#B7410E', 'sand': '#C2B280',
      'taupe': '#483C32', 'wine': '#722F37', 'sage': '#BCB88A',
      'mauve': '#E0B0FF', 'plum': '#8E4585', 'blush': '#DE5D83',
      'slate': '#708090', 'denim': '#1560BD', 'chocolate': '#7B3F00'
    };

    /**
     * Resolves a color name to a hex value.
     * Checks exact match first, then partial match.
     */
    function getColorHex(colorName) {
      var lower = colorName.toLowerCase().trim();
      if (colorMap[lower]) return colorMap[lower];
      /* Partial match: check if any key is contained in the color name */
      var keys = Object.keys(colorMap);
      for (var i = 0; i < keys.length; i++) {
        if (lower.indexOf(keys[i]) !== -1) return colorMap[keys[i]];
      }
      return '#cccccc'; /* Fallback neutral gray */
    }

    /* ------------------------------------------------------------------
       RENDER VARIANT OPTIONS
       Creates option buttons for each product option (e.g., Color, Size).
       Color: large rectangular buttons with color swatch on the left.
       Size: dropdown select with placeholder.
       ------------------------------------------------------------------ */
    function renderVariants(product) {
      popupVariants.innerHTML = '';

      /* If product has no options or only default option, skip rendering */
      if (!product.options || product.options.length === 0) {
        addToCartBtn.disabled = false;
        return;
      }

      /* Check if single "Title" default option */
      if (product.options.length === 1 && product.options[0].name === 'Title' && product.options[0].values.length === 1 && product.options[0].values[0] === 'Default Title') {
        addToCartBtn.disabled = false;
        return;
      }

      /* Sort options so Color/Colour always appears before Size */
      var sortedOptions = product.options.slice().sort(function(a, b) {
        var aName = a.name.toLowerCase();
        var bName = b.name.toLowerCase();
        if (aName === 'color' || aName === 'colour') return -1;
        if (bName === 'color' || bName === 'colour') return 1;
        return 0;
      });

      sortedOptions.forEach(function(option) {
        /* Create option group container */
        var group = document.createElement('div');
        group.className = 'custom-popup__variant-group';

        /* Label for the option (e.g., "Color", "Size") */
        var label = document.createElement('span');
        label.className = 'custom-popup__variant-label';
        label.textContent = option.name;
        group.appendChild(label);

        var optionNameLower = option.name.toLowerCase();

        /* Size option: render as a dropdown select */
        if (optionNameLower === 'size') {
          var selectWrapper = document.createElement('div');
          selectWrapper.className = 'custom-popup__select-wrapper';

          var select = document.createElement('select');
          select.className = 'custom-popup__variant-select';
          select.setAttribute('data-option-name', option.name);

          /* Placeholder option */
          var placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Choose your ' + optionNameLower;
          placeholder.disabled = true;
          placeholder.selected = true;
          select.appendChild(placeholder);

          option.values.forEach(function(value) {
            var opt = document.createElement('option');
            opt.value = value;
            opt.textContent = value;
            select.appendChild(opt);
          });

          select.addEventListener('change', function() {
            selectOption(option.name, this.value, group);
          });

          selectWrapper.appendChild(select);
          group.appendChild(selectWrapper);

        /* Color option: render as rectangular text buttons in 2-column grid */
        } else if (optionNameLower === 'color' || optionNameLower === 'colour') {
          var optionsContainer = document.createElement('div');
          optionsContainer.className = 'custom-popup__variant-options custom-popup__variant-options--color';

          option.values.forEach(function(value) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'custom-popup__variant-option custom-popup__color-btn';
            btn.setAttribute('data-option-name', option.name);
            btn.setAttribute('data-option-value', value);

            /* Add colored left border accent using the color map */
            var hex = getColorHex(value);
            btn.style.borderLeftWidth = '4px';
            btn.style.borderLeftStyle = 'solid';
            btn.style.borderLeftColor = hex;

            /* Button text */
            btn.textContent = value;

            btn.addEventListener('click', function() {
              selectOption(option.name, value, optionsContainer);
            });

            optionsContainer.appendChild(btn);
          });

          group.appendChild(optionsContainer);

        } else {
          /* Other options: render as standard buttons */
          var optionsContainer = document.createElement('div');
          optionsContainer.className = 'custom-popup__variant-options';

          option.values.forEach(function(value) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'custom-popup__variant-option';
            btn.textContent = value;
            btn.setAttribute('data-option-name', option.name);
            btn.setAttribute('data-option-value', value);

            btn.addEventListener('click', function() {
              selectOption(option.name, value, optionsContainer);
            });

            optionsContainer.appendChild(btn);
          });

          group.appendChild(optionsContainer);
        }

        popupVariants.appendChild(group);
      });
    }

    /* ------------------------------------------------------------------
       SELECT OPTION
       Marks an option as selected, updates state, and checks if a valid
       variant combination exists.
       ------------------------------------------------------------------ */
    function selectOption(optionName, optionValue, container) {
      /* Update selection state */
      selectedOptions[optionName] = optionValue;

      /* Update visual selection: toggle selected class on buttons */
      var buttons = container.querySelectorAll('.custom-popup__variant-option');
      for (var i = 0; i < buttons.length; i++) {
        if (buttons[i].getAttribute('data-option-value') === optionValue) {
          buttons[i].classList.add('custom-popup__variant-option--selected');
        } else {
          buttons[i].classList.remove('custom-popup__variant-option--selected');
        }
      }

      /* Check if all options are selected */
      var allSelected = currentProduct.options.every(function(option) {
        return selectedOptions[option.name] !== undefined;
      });

      if (allSelected) {
        var matchedVariant = findMatchingVariant();
        if (matchedVariant && matchedVariant.available) {
          addToCartBtn.disabled = false;
          /* Update price to matched variant's price */
          popupPrice.textContent = matchedVariant.price;
        } else {
          addToCartBtn.disabled = true;
        }
      }

      /* Reset success message when options change */
      successMsg.classList.remove('custom-popup__success-message--visible');
    }

    /* ------------------------------------------------------------------
       FIND MATCHING VARIANT
       Matches selectedOptions against product variants to find the
       correct variant ID for the cart.
       ------------------------------------------------------------------ */
    function findMatchingVariant() {
      if (!currentProduct || !currentProduct.variants) return null;

      return currentProduct.variants.find(function(variant) {
        return currentProduct.options.every(function(option, index) {
          return variant.options[index] === selectedOptions[option.name];
        });
      });
    }

    /* ------------------------------------------------------------------
       ADD TO CART
       Uses Shopify /cart/add.js endpoint (fetch API, no jQuery).
       Also handles the "Soft Winter Jacket" auto-add rule.
       ------------------------------------------------------------------ */
    function addToCart() {
      var variant = findMatchingVariant();
      if (!variant) return;

      /* Show loading state */
      addToCartBtn.classList.add('custom-popup__add-to-cart--loading');
      addToCartBtn.disabled = true;

      /* Build the items array for the cart request */
      var items = [{ id: variant.id, quantity: 1 }];

      /* ------------------------------------------------------------------
         SPECIAL RULE: Auto-add "Soft Winter Jacket"
         If the selected variant has "Black" AND "Medium" among its options,
         also add the Soft Winter Jacket to the cart.
         ------------------------------------------------------------------ */
      var optionValues = Object.values(selectedOptions).map(function(v) {
        return v.toLowerCase();
      });
      var hasBlack = optionValues.indexOf('black') !== -1;
      var hasMedium = optionValues.indexOf('medium') !== -1;

      if (hasBlack && hasMedium && softWinterJacketData) {
        items.push({
          id: softWinterJacketData.firstAvailableVariantId,
          quantity: 1
        });
      }

      /* POST to Shopify Cart API */
      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: items })
      })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Failed to add to cart');
        }
        return response.json();
      })
      .then(function() {
        /* Show success feedback */
        addToCartBtn.classList.remove('custom-popup__add-to-cart--loading');
        addToCartBtn.innerHTML = '<span class="custom-popup__atc-text">ADDED!</span>';
        successMsg.classList.add('custom-popup__success-message--visible');

        /* Update cart count in header if a bubble/counter element exists */
        updateCartCount();

        /* Reset button text after 2 seconds */
        setTimeout(function() {
          addToCartBtn.innerHTML = '<span class="custom-popup__atc-text">ADD TO CART</span><span class="custom-popup__atc-arrow"></span>';
          addToCartBtn.disabled = false;
        }, 2000);
      })
      .catch(function(error) {
        console.error('Custom Product Grid: Add to cart failed', error);
        addToCartBtn.classList.remove('custom-popup__add-to-cart--loading');
        addToCartBtn.innerHTML = '<span class="custom-popup__atc-text">ERROR - TRY AGAIN</span>';
        addToCartBtn.disabled = false;

        /* Reset error text after 2 seconds */
        setTimeout(function() {
          addToCartBtn.innerHTML = '<span class="custom-popup__atc-text">ADD TO CART</span><span class="custom-popup__atc-arrow"></span>';
        }, 2000);
      });
    }

    /* ------------------------------------------------------------------
       UPDATE CART COUNT
       Fetches /cart.js to get the updated item count and updates any
       cart bubble/counter elements in the header.
       ------------------------------------------------------------------ */
    function updateCartCount() {
      fetch('/cart.js', {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(function(response) { return response.json(); })
      .then(function(cart) {
        /* Update common cart count selectors used across Shopify themes */
        var cartCountEls = document.querySelectorAll('[data-cart-count], .cart-count-bubble span, .cart-bubble__count');
        cartCountEls.forEach(function(el) {
          el.textContent = cart.item_count;
        });
      })
      .catch(function(error) {
        console.error('Custom Product Grid: Failed to update cart count', error);
      });
    }

    /* ------------------------------------------------------------------
       EVENT LISTENERS — uses event delegation on the section container
       so clicks work even if cards are rendered dynamically.
       ------------------------------------------------------------------ */
    var sectionEl = document.getElementById('ProductGrid-' + sectionId);

    /* Delegated click: hotspot or card opens popup */
    sectionEl.addEventListener('click', function(e) {
      /* Check for hotspot click first (more specific) */
      var hotspot = e.target.closest('[data-popup-trigger]');
      if (hotspot) {
        e.stopPropagation();
        openPopup(hotspot.getAttribute('data-popup-trigger'));
        return;
      }

      /* Check for card click (entire card is clickable) */
      var card = e.target.closest('.custom-product-grid__card');
      if (card) {
        openPopup(card.getAttribute('data-product-handle'));
        return;
      }
    });

    /* Close popup: click close button */
    closeBtn.addEventListener('click', function() {
      closePopup();
    });

    /* Close popup: click outside the popup (on the overlay) */
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        closePopup();
      }
    });

    /* Close popup: press Escape key */
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('custom-popup-overlay--active')) {
        closePopup();
      }
    });

    /* Add to Cart button click */
    addToCartBtn.addEventListener('click', function() {
      addToCart();
    });

  })();
</script>

{% schema %}
{
  "name": "Custom Product Grid",
  "tag": "section",
  "class": "custom-product-grid-section",
  "settings": [
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "t:settings.section_width",
      "options": [
        {
          "value": "page-width",
          "label": "t:options.page"
        },
        {
          "value": "full-width",
          "label": "t:options.full"
        }
      ],
      "default": "full-width"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:settings.columns"
    },
    {
      "type": "range",
      "id": "columns",
      "label": "t:settings.columns",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 3
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "t:settings.mobile_columns",
      "options": [
        {
          "value": "1",
          "label": "1"
        },
        {
          "value": "2",
          "label": "2"
        }
      ],
      "default": "2"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "t:settings.products_per_page",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 6
    },
    {
      "type": "header",
      "content": "t:content.text"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "t:settings.heading",
      "default": "Featured Products"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "t:settings.alignment",
      "options": [
        {
          "value": "left",
          "label": "t:options.left"
        },
        {
          "value": "center",
          "label": "t:options.center"
        },
        {
          "value": "right",
          "label": "t:options.right"
        }
      ],
      "default": "left"
    },
    {
      "type": "range",
      "id": "heading_size",
      "label": "t:content.heading_size",
      "min": 14,
      "max": 48,
      "step": 1,
      "unit": "px",
      "default": 20
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "blocks": [
    {
      "type": "custom-product-card"
    }
  ],
  "presets": [
    {
      "name": "Custom Product Grid",
      "blocks": [
        { "type": "custom-product-card" },
        { "type": "custom-product-card" },
        { "type": "custom-product-card" },
        { "type": "custom-product-card" },
        { "type": "custom-product-card" },
        { "type": "custom-product-card" }
      ]
    }
  ]
}
{% endschema %}
