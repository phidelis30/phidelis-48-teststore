{% comment %}
  ============================================================================
  Section: Custom Product Grid
  ============================================================================
  Displays a grid of 6 selectable products. Each product card has a clickable
  hotspot that opens a popup/modal showing full product details including:
    - Product name, price, description
    - Dynamic variant options (rendered from product data)
    - Functional "Add to Cart" button using Shopify Cart API

  Special Rule:
    When any product with variant options "Black" AND "Medium" is added to
    the cart, the "Soft Winter Jacket" product is also automatically added.

  Requirements:
    - No jQuery — vanilla JavaScript only
    - Products are selectable from the customizer via blocks
    - Mobile responsive (2-col on mobile, 3-col on desktop)
  ============================================================================
{% endcomment %}

{{ 'custom-sections.css' | asset_url | stylesheet_tag }}

<section
  id="ProductGrid-{{ section.id }}"
  class="custom-product-grid"
  data-section-id="{{ section.id }}"
  data-section-type="custom-product-grid"
>

  {%- comment -%} Section heading {%- endcomment -%}
  {%- if section.settings.heading != blank -%}
    <h2 class="custom-product-grid__heading">{{ section.settings.heading }}</h2>
  {%- endif -%}

  {%- comment -%} Product cards grid {%- endcomment -%}
  <div class="custom-product-grid__grid">
    {%- for block in section.blocks -%}
      {%- assign product = block.settings.product -%}
      {%- if product != blank -%}
        <div
          class="custom-product-grid__card"
          data-product-handle="{{ product.handle }}"
          data-block-id="{{ block.id }}"
          {{ block.shopify_attributes }}
        >
          {%- comment -%} Product image with hotspot button {%- endcomment -%}
          <div class="custom-product-grid__image-wrapper">
            {%- if product.featured_image != blank -%}
              <img
                class="custom-product-grid__image"
                src="{{ product.featured_image | image_url: width: 600 }}"
                alt="{{ product.featured_image.alt | escape }}"
                width="600"
                height="600"
                loading="lazy"
              >
            {%- else -%}
              {{ 'product-1' | placeholder_svg_tag: 'custom-product-grid__image' }}
            {%- endif -%}

            {%- comment -%} Hotspot circle button — opens popup on click {%- endcomment -%}
            <button
              class="custom-product-grid__hotspot"
              type="button"
              aria-label="View {{ product.title | escape }} details"
              data-popup-trigger="{{ product.handle }}"
            >
              <span class="custom-product-grid__hotspot-icon">+</span>
            </button>
          </div>

          {%- comment -%} Product title and price below image {%- endcomment -%}
          <div class="custom-product-grid__info">
            <h3 class="custom-product-grid__title">{{ product.title }}</h3>
            <p class="custom-product-grid__price">{{ product.price | money }}</p>
          </div>
        </div>
      {%- endif -%}
    {%- endfor -%}
  </div>

  {%- comment -%}
    ========================================================================
    Popup Overlay — Single shared popup, populated dynamically via JS
    ========================================================================
  {%- endcomment -%}
  <div
    id="CustomPopupOverlay-{{ section.id }}"
    class="custom-popup-overlay"
    role="dialog"
    aria-modal="true"
    aria-label="Product details"
  >
    <div class="custom-popup">
      {%- comment -%} Close button {%- endcomment -%}
      <button class="custom-popup__close" type="button" aria-label="Close popup">&times;</button>

      {%- comment -%} Product image (left side) {%- endcomment -%}
      <div class="custom-popup__image-wrapper">
        <img class="custom-popup__image" src="" alt="" loading="lazy">
      </div>

      {%- comment -%} Product details (right side) {%- endcomment -%}
      <div class="custom-popup__details">
        <h2 class="custom-popup__name"></h2>
        <p class="custom-popup__price"></p>
        <p class="custom-popup__description"></p>

        {%- comment -%} Variant options container — built dynamically by JS {%- endcomment -%}
        <div class="custom-popup__variants"></div>

        {%- comment -%} Success message after add to cart {%- endcomment -%}
        <div class="custom-popup__success-message">Added to cart successfully!</div>

        {%- comment -%} Add to Cart button {%- endcomment -%}
        <button
          class="custom-popup__add-to-cart"
          type="button"
          disabled
        >
          ADD TO CART
        </button>
      </div>
    </div>
  </div>

  {%- comment -%}
    ========================================================================
    Product Data Store
    Serializes all block product data as JSON so vanilla JS can access it
    without additional API calls. Includes variants, options, and images.
    ========================================================================
  {%- endcomment -%}
  <script type="application/json" id="CustomProductData-{{ section.id }}">
    {
      {%- for block in section.blocks -%}
        {%- assign product = block.settings.product -%}
        {%- if product != blank -%}
          "{{ product.handle }}": {
            "id": {{ product.id }},
            "title": {{ product.title | json }},
            "handle": {{ product.handle | json }},
            "description": {{ product.description | strip_html | truncate: 300 | json }},
            "price": {{ product.price | money | json }},
            "image": {{ product.featured_image | image_url: width: 800 | json }},
            "imageAlt": {{ product.featured_image.alt | default: product.title | json }},
            "options": [
              {%- for option in product.options_with_values -%}
                {
                  "name": {{ option.name | json }},
                  "values": {{ option.values | json }}
                }{%- unless forloop.last -%},{%- endunless -%}
              {%- endfor -%}
            ],
            "variants": [
              {%- for variant in product.variants -%}
                {
                  "id": {{ variant.id }},
                  "title": {{ variant.title | json }},
                  "price": {{ variant.price | money | json }},
                  "available": {{ variant.available }},
                  "options": {{ variant.options | json }}
                }{%- unless forloop.last -%},{%- endunless -%}
              {%- endfor -%}
            ]
          }{%- unless forloop.last -%},{%- endunless -%}
        {%- endif -%}
      {%- endfor -%}
    }
  </script>

  {%- comment -%}
    ========================================================================
    Store all product handles for the "Soft Winter Jacket" auto-add rule.
    We find the Soft Winter Jacket variant ID at runtime.
    ========================================================================
  {%- endcomment -%}
  {%- assign soft_winter_jacket = all_products['soft-winter-jacket'] -%}
  {%- if soft_winter_jacket != blank -%}
    <script type="application/json" id="SoftWinterJacketData-{{ section.id }}">
      {
        "id": {{ soft_winter_jacket.id }},
        "handle": "soft-winter-jacket",
        "firstAvailableVariantId": {{ soft_winter_jacket.selected_or_first_available_variant.id }}
      }
    </script>
  {%- endif -%}

</section>

{%- comment -%}
  ============================================================================
  Vanilla JavaScript — Product Grid Popup & Add to Cart
  ============================================================================
  - No jQuery dependency
  - Opens popup with product data on hotspot click
  - Renders variant options dynamically
  - Matches selected options to the correct variant ID
  - Adds to cart via Shopify /cart/add.js API
  - Auto-adds "Soft Winter Jacket" when variant with Black + Medium is carted
  ============================================================================
{%- endcomment -%}
<script>
  (function() {
    'use strict';

    /* ------------------------------------------------------------------
       CONFIGURATION & DOM REFERENCES
       ------------------------------------------------------------------ */
    var sectionId = '{{ section.id }}';
    var overlay = document.getElementById('CustomPopupOverlay-' + sectionId);
    var popup = overlay.querySelector('.custom-popup');
    var closeBtn = overlay.querySelector('.custom-popup__close');
    var popupImage = overlay.querySelector('.custom-popup__image');
    var popupName = overlay.querySelector('.custom-popup__name');
    var popupPrice = overlay.querySelector('.custom-popup__price');
    var popupDesc = overlay.querySelector('.custom-popup__description');
    var popupVariants = overlay.querySelector('.custom-popup__variants');
    var addToCartBtn = overlay.querySelector('.custom-popup__add-to-cart');
    var successMsg = overlay.querySelector('.custom-popup__success-message');

    /* ------------------------------------------------------------------
       LOAD PRODUCT DATA FROM JSON STORE
       ------------------------------------------------------------------ */
    var dataEl = document.getElementById('CustomProductData-' + sectionId);
    var productData = {};
    if (dataEl) {
      try {
        productData = JSON.parse(dataEl.textContent);
      } catch (e) {
        console.error('Custom Product Grid: Failed to parse product data', e);
      }
    }

    /* Load Soft Winter Jacket data if available */
    var softWinterJacketData = null;
    var jacketDataEl = document.getElementById('SoftWinterJacketData-' + sectionId);
    if (jacketDataEl) {
      try {
        softWinterJacketData = JSON.parse(jacketDataEl.textContent);
      } catch (e) {
        console.error('Custom Product Grid: Failed to parse jacket data', e);
      }
    }

    /* ------------------------------------------------------------------
       STATE: tracks currently selected options for the open popup
       ------------------------------------------------------------------ */
    var currentProduct = null;    /* The product object currently in the popup */
    var selectedOptions = {};     /* { optionName: selectedValue } */

    /* ------------------------------------------------------------------
       OPEN POPUP
       Populates all popup fields from the product data store.
       ------------------------------------------------------------------ */
    function openPopup(handle) {
      var product = productData[handle];
      if (!product) return;

      currentProduct = product;
      selectedOptions = {};

      /* Populate basic product info */
      popupImage.src = product.image;
      popupImage.alt = product.imageAlt;
      popupName.textContent = product.title;
      popupPrice.textContent = product.price;
      popupDesc.textContent = product.description;

      /* Build variant option groups dynamically */
      renderVariants(product);

      /* Reset button and messages */
      addToCartBtn.disabled = true;
      addToCartBtn.classList.remove('custom-popup__add-to-cart--loading');
      addToCartBtn.textContent = 'ADD TO CART';
      successMsg.classList.remove('custom-popup__success-message--visible');

      /* Show overlay with animation */
      overlay.classList.add('custom-popup-overlay--active');
      document.body.style.overflow = 'hidden';

      /* Focus trap: focus the close button for accessibility */
      closeBtn.focus();
    }

    /* ------------------------------------------------------------------
       CLOSE POPUP
       ------------------------------------------------------------------ */
    function closePopup() {
      overlay.classList.remove('custom-popup-overlay--active');
      document.body.style.overflow = '';
      currentProduct = null;
      selectedOptions = {};
    }

    /* ------------------------------------------------------------------
       RENDER VARIANT OPTIONS
       Creates option buttons for each product option (e.g., Color, Size).
       ------------------------------------------------------------------ */
    function renderVariants(product) {
      popupVariants.innerHTML = '';

      /* If product has no options or only default option, skip rendering */
      if (!product.options || product.options.length === 0) {
        /* Auto-select the first variant if no options */
        addToCartBtn.disabled = false;
        return;
      }

      /* Check if single "Title" default option */
      if (product.options.length === 1 && product.options[0].name === 'Title' && product.options[0].values.length === 1 && product.options[0].values[0] === 'Default Title') {
        addToCartBtn.disabled = false;
        return;
      }

      product.options.forEach(function(option) {
        /* Create option group container */
        var group = document.createElement('div');
        group.className = 'custom-popup__variant-group';

        /* Label for the option (e.g., "Color", "Size") */
        var label = document.createElement('span');
        label.className = 'custom-popup__variant-label';
        label.textContent = option.name;
        group.appendChild(label);

        /* Container for option value buttons */
        var optionsContainer = document.createElement('div');
        optionsContainer.className = 'custom-popup__variant-options';

        option.values.forEach(function(value) {
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'custom-popup__variant-option';
          btn.textContent = value;
          btn.setAttribute('data-option-name', option.name);
          btn.setAttribute('data-option-value', value);

          /* Click handler: select this variant option */
          btn.addEventListener('click', function() {
            selectOption(option.name, value, optionsContainer);
          });

          optionsContainer.appendChild(btn);
        });

        group.appendChild(optionsContainer);
        popupVariants.appendChild(group);
      });
    }

    /* ------------------------------------------------------------------
       SELECT OPTION
       Marks an option as selected, updates state, and checks if a valid
       variant combination exists.
       ------------------------------------------------------------------ */
    function selectOption(optionName, optionValue, container) {
      /* Update selection state */
      selectedOptions[optionName] = optionValue;

      /* Update visual selection: toggle selected class on buttons */
      var buttons = container.querySelectorAll('.custom-popup__variant-option');
      for (var i = 0; i < buttons.length; i++) {
        if (buttons[i].getAttribute('data-option-value') === optionValue) {
          buttons[i].classList.add('custom-popup__variant-option--selected');
        } else {
          buttons[i].classList.remove('custom-popup__variant-option--selected');
        }
      }

      /* Check if all options are selected */
      var allSelected = currentProduct.options.every(function(option) {
        return selectedOptions[option.name] !== undefined;
      });

      if (allSelected) {
        var matchedVariant = findMatchingVariant();
        if (matchedVariant && matchedVariant.available) {
          addToCartBtn.disabled = false;
          /* Update price to matched variant's price */
          popupPrice.textContent = matchedVariant.price;
        } else {
          addToCartBtn.disabled = true;
        }
      }

      /* Reset success message when options change */
      successMsg.classList.remove('custom-popup__success-message--visible');
    }

    /* ------------------------------------------------------------------
       FIND MATCHING VARIANT
       Matches selectedOptions against product variants to find the
       correct variant ID for the cart.
       ------------------------------------------------------------------ */
    function findMatchingVariant() {
      if (!currentProduct || !currentProduct.variants) return null;

      return currentProduct.variants.find(function(variant) {
        return currentProduct.options.every(function(option, index) {
          return variant.options[index] === selectedOptions[option.name];
        });
      });
    }

    /* ------------------------------------------------------------------
       ADD TO CART
       Uses Shopify /cart/add.js endpoint (fetch API, no jQuery).
       Also handles the "Soft Winter Jacket" auto-add rule.
       ------------------------------------------------------------------ */
    function addToCart() {
      var variant = findMatchingVariant();
      if (!variant) return;

      /* Show loading state */
      addToCartBtn.classList.add('custom-popup__add-to-cart--loading');
      addToCartBtn.disabled = true;

      /* Build the items array for the cart request */
      var items = [{ id: variant.id, quantity: 1 }];

      /* ------------------------------------------------------------------
         SPECIAL RULE: Auto-add "Soft Winter Jacket"
         If the selected variant has "Black" AND "Medium" among its options,
         also add the Soft Winter Jacket to the cart.
         ------------------------------------------------------------------ */
      var optionValues = Object.values(selectedOptions).map(function(v) {
        return v.toLowerCase();
      });
      var hasBlack = optionValues.indexOf('black') !== -1;
      var hasMedium = optionValues.indexOf('medium') !== -1;

      if (hasBlack && hasMedium && softWinterJacketData) {
        items.push({
          id: softWinterJacketData.firstAvailableVariantId,
          quantity: 1
        });
      }

      /* POST to Shopify Cart API */
      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: items })
      })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Failed to add to cart');
        }
        return response.json();
      })
      .then(function() {
        /* Show success feedback */
        addToCartBtn.classList.remove('custom-popup__add-to-cart--loading');
        addToCartBtn.textContent = 'ADDED!';
        successMsg.classList.add('custom-popup__success-message--visible');

        /* Update cart count in header if a bubble/counter element exists */
        updateCartCount();

        /* Reset button text after 2 seconds */
        setTimeout(function() {
          addToCartBtn.textContent = 'ADD TO CART';
          addToCartBtn.disabled = false;
        }, 2000);
      })
      .catch(function(error) {
        console.error('Custom Product Grid: Add to cart failed', error);
        addToCartBtn.classList.remove('custom-popup__add-to-cart--loading');
        addToCartBtn.textContent = 'ERROR - TRY AGAIN';
        addToCartBtn.disabled = false;

        /* Reset error text after 2 seconds */
        setTimeout(function() {
          addToCartBtn.textContent = 'ADD TO CART';
        }, 2000);
      });
    }

    /* ------------------------------------------------------------------
       UPDATE CART COUNT
       Fetches /cart.js to get the updated item count and updates any
       cart bubble/counter elements in the header.
       ------------------------------------------------------------------ */
    function updateCartCount() {
      fetch('/cart.js', {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(function(response) { return response.json(); })
      .then(function(cart) {
        /* Update common cart count selectors used across Shopify themes */
        var cartCountEls = document.querySelectorAll('[data-cart-count], .cart-count-bubble span, .cart-bubble__count');
        cartCountEls.forEach(function(el) {
          el.textContent = cart.item_count;
        });
      })
      .catch(function(error) {
        console.error('Custom Product Grid: Failed to update cart count', error);
      });
    }

    /* ------------------------------------------------------------------
       EVENT LISTENERS
       ------------------------------------------------------------------ */

    /* Hotspot click: open popup for the associated product */
    var hotspots = document.querySelectorAll('#ProductGrid-' + sectionId + ' [data-popup-trigger]');
    hotspots.forEach(function(hotspot) {
      hotspot.addEventListener('click', function(e) {
        e.stopPropagation();
        var handle = this.getAttribute('data-popup-trigger');
        openPopup(handle);
      });
    });

    /* Card click: also open popup (entire card is clickable) */
    var cards = document.querySelectorAll('#ProductGrid-' + sectionId + ' .custom-product-grid__card');
    cards.forEach(function(card) {
      card.addEventListener('click', function() {
        var handle = this.getAttribute('data-product-handle');
        openPopup(handle);
      });
    });

    /* Close popup: click close button */
    closeBtn.addEventListener('click', function() {
      closePopup();
    });

    /* Close popup: click outside the popup (on the overlay) */
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        closePopup();
      }
    });

    /* Close popup: press Escape key */
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('custom-popup-overlay--active')) {
        closePopup();
      }
    });

    /* Add to Cart button click */
    addToCartBtn.addEventListener('click', function() {
      addToCart();
    });

  })();
</script>

{% schema %}
{
  "name": "Custom Product Grid",
  "tag": "section",
  "class": "custom-product-grid-section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Featured Products"
    }
  ],
  "blocks": [
    {
      "type": "product_card",
      "name": "Product",
      "limit": 6,
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Product Grid",
      "blocks": [
        { "type": "product_card" },
        { "type": "product_card" },
        { "type": "product_card" },
        { "type": "product_card" },
        { "type": "product_card" },
        { "type": "product_card" }
      ]
    }
  ]
}
{% endschema %}
